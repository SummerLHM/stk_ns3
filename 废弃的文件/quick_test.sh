#!/bin/bash
# /repos_ns3/ns-3-allinone/ns-3.45/scratch/starlink/quick_test.sh
# 快速测试脚本

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
NS3_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

echo ""
echo "==========================================="
echo "  🧪 NS3 快速测试"
echo "==========================================="
echo ""

#=============================================================================
# 1. 创建测试数据
#=============================================================================

echo "[1/4] 创建测试数据..."

mkdir -p "$SCRIPT_DIR/data/input"
mkdir -p "$SCRIPT_DIR/data/output"

TEST_INPUT="$SCRIPT_DIR/data/input/test_links.csv"
TEST_OUTPUT="$SCRIPT_DIR/data/output/test_results.csv"

cat > "$TEST_INPUT" << 'EOF'
src_id,dst_id,src_name,dst_name,delay_ms,data_rate_bps,packet_loss_rate,distance_km
0,1,Sat_0_0,Sat_0_1,3.50,14000000,0.0001,1050
1,2,Sat_0_1,Sat_0_2,3.60,14000000,0.0001,1080
2,3,Sat_0_2,Sat_0_3,3.40,14000000,0.0001,1020
3,4,Sat_0_3,Sat_0_4,3.50,14000000,0.0001,1050
4,5,Sat_0_4,Sat_1_0,4.20,14000000,0.0002,1260
5,6,Sat_1_0,Sat_1_1,3.50,14000000,0.0001,1050
6,7,Sat_1_1,Sat_1_2,3.60,14000000,0.0001,1080
7,8,Sat_1_2,Sat_1_3,3.40,14000000,0.0001,1020
8,9,Sat_1_3,Sat_1_4,3.50,14000000,0.0001,1050
0,5,Sat_0_0,Sat_1_0,4.10,14000000,0.0002,1230
1,6,Sat_0_1,Sat_1_1,4.30,14000000,0.0002,1290
2,7,Sat_0_2,Sat_1_2,4.00,14000000,0.0002,1200
EOF

echo "✅ 测试数据: 10节点, 12链路"

#=============================================================================
# 2. 编译
#=============================================================================

echo ""
echo "[2/4] 编译..."

cd "$NS3_ROOT"
./ns3 build scratch/starlink/starlink-sim 2>&1 | grep -E "(Compiling|Linking|Built)" | head -5 || true
echo "✅ 编译完成"

#=============================================================================
# 3. 运行测试
#=============================================================================

echo ""
echo "[3/4] 运行测试仿真 (5秒)..."

./ns3 run "scratch/starlink/starlink-sim -- \
    --linkParams=$TEST_INPUT \
    --output=$TEST_OUTPUT \
    --simTime=5 \
    --numFlows=3"

#=============================================================================
# 4. 验证结果
#=============================================================================

echo ""
echo "[4/4] 验证结果..."

if [ -f "$TEST_OUTPUT" ]; then
    echo "✅ 测试成功!"
    echo ""
    echo "结果预览:"
    echo "==========================================="
    head -10 "$TEST_OUTPUT" | column -t -s',' 2>/dev/null || head -10 "$TEST_OUTPUT"
    echo "==========================================="
else
    echo "❌ 测试失败"
    exit 1
fi

echo ""
echo "==========================================="
echo "  ✅ NS3环境正常!"
echo "==========================================="
echo ""
echo "现在可以运行正式仿真: bash run.sh"
echo ""
